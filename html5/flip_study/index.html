<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-zoom=1.0">
<script src="./flip.js"></script>
<body>
    <button name="mark-all">Mark all</button>
    <div>
        <input maxlength="30" name="todo"><button name="add">Add to-do</button>
    </div>
    <script>
        const mark_all = document.querySelector("button[name=mark-all]")
        const add_todo = document.querySelector("button[name=add]")

        const todo_input = document.querySelector("input[name=todo]")
        const todos_div = document.createElement("div")
        todos_div.style.position = 'relative'
        todos_div.style.margin = 'auto'
        todos_div.style.width = '33vw'
        document.body.append(todos_div)

        add_todo.onclick = _ => {
            if (!todo_input.value) return
            todos_div.append(create_div({ text: todo_input.value }, protocol))
            todo_input.value = ''
        }

        function protocol(notify) {
            return listen
        }
        function listen(msg) {

        }

        function create_div(options = {}, protocol) {
            const notify = protocol ? protocol(listen) : undefined
            const { duration = 400, by = 100, direction = 'right', text } = options
            const el = document.createElement("div")
            const shadow = el.attachShadow({mode:"closed"})
            const div = document.createElement("div")
            const text_p = document.createElement("p")
            text_p.textContent ||= text
            Object.assign(text_p.style, {display: 'flex', margin: 0})
            div.append(text_p)
            div.animate([{
                originTransform: 'top left',
                transform: `translateX(-5em)`,
                opacity: 0,
            }, {
                transform: 'none',
                opacity: 1,
            }], {
                fill: 'both',
                duration: duration,
                easing: 'ease-in',
            })
            Object.assign(div.style, {
                minWidth: '5em', minHeight: '2em',
                display: 'flex',
                justifyContent: 'center', alignItems: 'center',
            })
            const close = document.createElement("button")
            close.textContent = 'X'
            Object.assign(close.style, {
                position: 'absolute', right: 0, top: '50%', width: '1.5em', height: '1.5em',
                transform: 'translateY(-50%)',
                outline: 'none', backgroundColor: 'transparent'
            })
            const animation_options = { direction, by, duration }
            close.onclick = function () {
                new FLIP(el.parentNode)
                    .wrap(_ =>
                        slide_and_fade(div, animation_options),
                        animation_options
                    )()
            }
            div.append(close)
            shadow.append(div)
            return el

            function listen(msg) {

            }
        }

        /**
         * @param {HTMLElement} element
         * @param {any} options
         */
        function slide_and_fade(original, { direction = 'top', by = 400, duration = 200 }) {
            const first = FLIP.snap(original)

            const clone = original.cloneNode(true)
            const rect = original.getBoundingClientRect()

            clone.style.position = 'absolute'
            const d = ['top', 'bottom'].includes(direction) ? 'top' : 'left'
            const increment = by * (['top', 'left'].includes(direction) ? -1 : 1)
            clone.style[d] = rect[d] + increment + 'px'
            clone.style.opacity = 0

            original.replaceWith(clone)

            FLIP.flip({ first, last: clone }, { duration })
            setTimeout(_ => clone.remove(), duration)

            return clone
        }
    </script>
</body>
<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-zoom=1.0">
<script src="./flip.js"></script>

<body>
    <button name="Add">Add div</button>
    <button name="reverse">Reverse all</button>
    <div>
        <input name="n"><button name="add n">Add N divs</button>
    </div>
    <script>
        const add_div = document.querySelector("button[name=Add]")
        const reverse_all = document.querySelector("button[name=reverse]")
        const add_n = document.querySelector("button[name='add n']")
        const n = document.querySelector("input[name=n]")
        const div = document.createElement("div")
        document.body.append(div)
        add_div.onclick = _ => create_div({ root: div })
        add_n.onclick = _ => {for (let i = 0; i < n.value; i++) create_div({ root: div })}
        reverse_all.onclick = _ => {
            const children = Array.from(div.children)
            const flip = new FLIP(div)
            flip.read()
            
            children.reverse()
            div.replaceChildren(...children)

            flip.flip({ duration: 800 })
        }

        function create_div(options = {}) {
            const { duration = 400, by = 100, direction = 'right', root = document.body } = options
            const div = document.createElement("div")
            div.animate([{
                originTransform: 'top left',
                transform: `translateX(-5em)`,
                opacity: 0,
            }, {
                transform: 'none',
                opacity: 1,
            }], {
                fill: 'both',
                duration: duration,
                easing: 'ease-in',
            })
            Object.assign(div.style, {
                position: 'relative', border: 'solid', width: '5em', height: '2em'
            })
            const close = document.createElement("button")
            close.textContent = 'X'
            Object.assign(close.style, {
                position: 'absolute', right: 0, top: '50%', width: '1.5em', height: '1.5em',
                transform: 'translateY(-50%)'
            })
            const animation_options = { direction, by, duration }
            close.onclick = new FLIP(root).wrap(_ => slide_and_fade(div, animation_options), animation_options)
            div.append(close)
            root.append(div)
            return div
        }

        /**
         * @param {HTMLElement} element
         * @param {any} options
         */
        function slide_and_fade(original, { direction = 'top', by = 400, duration = 200 }) {
            const first = FLIP.snap(original)

            const clone = original.cloneNode(true)
            const rect = original.getBoundingClientRect()

            clone.style.position = 'absolute'
            const d = ['top', 'bottom'].includes(direction) ? 'top' : 'left'
            const increment = by * (['top', 'left'].includes(direction) ? -1 : 1)
            clone.style[d] = rect[d] + increment + 'px'
            clone.style.opacity = 0
            
            original.replaceWith(clone)

            FLIP.flip({first, last: clone}, { duration })
            setTimeout(_ => clone.remove(), duration)
            
            return clone
        }
    </script>
</body>
<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-zoom=1.0">

<body>
    <button name="Add">Add div</button>
    <script>
        const add_div = document.querySelector("button[name=Add]")
        add_div.onclick = _ => document.body.append(create_div())

        function create_div(options = {}) {
            const { duration = 800, by = 100, direction = 'bottom' } = options
            const div = document.createElement("div")
            Object.assign(div.style, {
                position: 'relative', border: 'solid', width: '5em', height: '2em'
            })
            const close = document.createElement("button")
            close.textContent = 'X'
            Object.assign(close.style, {
                position: 'absolute', right: 0, top: '50%', width: '1.5em', height: '1.5em',
                transform: 'translateY(-50%)'
            })
            close.onclick = _ => {
                const parent = div.parentNode
                const children = [...parent.children]
                const before = new Map();
                children.map(el => before.set(el, { 
                    getBoundingClientRect: (_ => {
                        const rect = el.getBoundingClientRect()
                        return _ => rect
                    })(), 
                    style: Object.assign({}, el.style) 
                }))
                FLIP(div, _ => slide_and_fade(div, { direction, by, duration }), { duration })
                for (const [last, first] of before) {
                    FLIP({ first, last }, undefined, { duration })
                }
            }
            div.append(close)

            return div
        }

        /**
         * @param {HTMLElement} element
         * @param {any} options
         */
        function slide_and_fade(original, { direction = 'top', by = 400, duration = 200 }) {
            const clone = original.cloneNode(true)
            const rect = original.getBoundingClientRect()
            clone.style.position = 'absolute'
            const d = ['top', 'bottom'].includes(direction) ? 'top' : 'left'
            const increment = by * (['top', 'left'].includes(direction) ? -1 : 1)
            clone.style[d] = rect[d] + increment + 'px'
            clone.style.opacity = 0
            original.replaceWith(clone)
            setTimeout(_ => clone.remove(), duration)
            return clone
        }

        function FLIP(el, fn, options = {}) {
            const { duration = 200, easing = 'ease-in-out', fill = 'both', iterations = 1, iterationStart = 0 } = options
            const first_el = el?.first || el
            const first = first_el.getBoundingClientRect()
            const f_opacity = first_el.style.opacity || 1
            const last_el = (fn ? fn() : undefined) || el?.last || el
            const last = last_el.getBoundingClientRect()
            const l_opacity = last_el.style.opacity || 1

            const i = {
                top: first.top - last.top,
                left: first.left - last.left,
                width: first.width / last.width,
                height: first.height / last.height
            }
            console.log(i)

            last_el.animate([
                { transformOrigin: 'top left', opacity: f_opacity, transform: ` translate(${i.left}px, ${i.top}px)` },
                { transformOrigin: 'top left', opacity: l_opacity, transform: 'none' }
            ], {
                duration, easing, fill, iterations, iterationStart
            })
        }
    </script>
</body>
<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-zoom=1.0">

<body>
    <button name="Add">Add div</button>
    <script>
        const add_div = document.querySelector("button[name=Add]")
        add_div.onclick = _ => document.body.append(create_div())

        function create_div() {
            const div = document.createElement("div")
            Object.assign(div.style, {
                position: 'relative', border: 'solid', width: '5em', height: '2em'
            })
            const close = document.createElement("button")
            close.textContent = 'X'
            Object.assign(close.style, {
                position: 'absolute', right: 0, top: '50%', width: '1.5em', height: '1.5em',
                transform: 'translateY(-50%)'
            })
            close.onclick = FLIP(div, _ => slide_and_fade(div, { direction: 'top', by: 100, duration: 800 }), { duration: 800 })
            div.append(close)

            return div
        }

        /**
         * @param {HTMLElement} element
         * @param {any} options
         */
        function slide_and_fade(original, { direction = 'top', by = 400, duration = 200 }) {
            const clone = original.cloneNode(true)
            const rect = original.getBoundingClientRect()
            clone.style.position = 'absolute'
            const d = ['top', 'bottom'].includes(direction) ? 'top' : 'left'
            const increment = by * (['top', 'left'].includes(direction) ? -1 : 1)
            clone.style[d] = rect[d] + increment + 'px'
            clone.style.opacity = 0
            original.replaceWith(clone)
            setTimeout(_ => clone.remove(), duration)
            return clone
        }

        function FLIP(el, fn, options = {}) {
            const { duration = 200, easing = 'ease-in-out', fill = 'both', iterations = 1, iterationStart = 0 } = options
            return function () {
                const first = el.getBoundingClientRect()
                const f_opacity = el.style.opacity || 1
                const last_el = fn() || el
                const last = last_el.getBoundingClientRect()
                const l_opacity = last_el.style.opacity || 1

                const i = {
                    top: first.top - last.top,
                    left: first.left - last.left,
                    width: first.width / last.width,
                    height: first.height / last.height
                }

                last_el.animate([
                    { transformOrigin: 'top left', opacity: f_opacity, transform: ` translate(${i.left}px, ${i.top}px)` },
                    { transformOrigin: 'top left', opacity: l_opacity, transform: 'none' }
                ], {
                    duration, easing, fill, iterations, iterationStart
                })
            }
        }
    </script>
</body>